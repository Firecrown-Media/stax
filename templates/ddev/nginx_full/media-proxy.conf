# Remote Media Proxy Configuration for DDEV
# This configuration proxies media requests to remote CDN/WPEngine servers
# to avoid downloading large media libraries locally

# Proxy wp-content/uploads requests to remote sources
location ~ ^/wp-content/uploads/(.*)$ {
    # Try local file first
    try_files $uri @proxy_media;
}

location @proxy_media {
    # Set upstream variables
    set $upstream_bunnycdn {{.CDN_URL}};
    set $upstream_wpengine {{.WPENGINE_URL}};

    # Try BunnyCDN first (if configured)
    {{if .CDN_ENABLED}}
    proxy_pass $upstream_bunnycdn$request_uri;
    proxy_ssl_server_name on;
    proxy_ssl_verify off;
    proxy_intercept_errors on;
    recursive_error_pages on;

    # If BunnyCDN returns 404, try WPEngine
    error_page 404 = @proxy_wpengine;

    # Headers for BunnyCDN
    proxy_set_header Host {{.CDN_HOST}};
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Hide upstream headers
    proxy_hide_header Set-Cookie;
    proxy_ignore_headers Set-Cookie;

    # Caching
    {{if .CACHE_ENABLED}}
    proxy_cache media_cache;
    proxy_cache_valid 200 {{.CACHE_TTL}};
    proxy_cache_valid 404 1m;
    proxy_cache_key "$scheme$request_method$host$request_uri";
    add_header X-Cache-Status $upstream_cache_status;
    {{end}}
    {{else}}
    # BunnyCDN disabled, go straight to WPEngine
    return 307 @proxy_wpengine;
    {{end}}
}

location @proxy_wpengine {
    # Proxy to WPEngine
    proxy_pass $upstream_wpengine$request_uri;
    proxy_ssl_server_name on;
    proxy_ssl_verify off;

    # Headers for WPEngine
    proxy_set_header Host {{.WPENGINE_HOST}};
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Hide upstream headers
    proxy_hide_header Set-Cookie;
    proxy_ignore_headers Set-Cookie;

    # Caching
    {{if .CACHE_ENABLED}}
    proxy_cache media_cache;
    proxy_cache_valid 200 {{.CACHE_TTL}};
    proxy_cache_key "$scheme$request_method$host$request_uri";
    add_header X-Cache-Status $upstream_cache_status;
    add_header X-Proxy-Source "wpengine";
    {{end}}
}

# Cache configuration
{{if .CACHE_ENABLED}}
proxy_cache_path /var/cache/nginx/media
    levels=1:2
    keys_zone=media_cache:10m
    max_size={{.CACHE_MAX_SIZE}}
    inactive={{.CACHE_TTL}}
    use_temp_path=off;
{{end}}
