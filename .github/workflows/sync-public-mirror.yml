name: Sync Public Mirror

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to sync (leave empty for latest release)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  sync-to-public:
    runs-on: ubuntu-latest

    steps:
      - name: Determine tag to sync
        id: get-tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            # Get latest release tag
            LATEST_TAG=$(gh api repos/${{ github.repository }}/releases/latest --jq .tag_name)
            echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout at release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get-tag.outputs.tag }}
          fetch-depth: 0

      - name: Clean sensitive files
        run: |
          echo "Cleaning sensitive and development files..."

          # Remove Claude AI artifacts
          rm -rf .claude/
          rm -f .claude.md *.claude.md CLAUDE.md

          # Remove build artifacts
          rm -rf dist/
          rm -f stax

          # Remove macOS artifacts
          find . -name ".DS_Store" -type f -delete

          # Remove temporary and cache files
          rm -rf .cache/
          rm -rf tmp/

          # Remove GitHub workflows (not needed in public mirror, causes deploy key issues)
          rm -rf .github/workflows/
          git rm -rf --cached .github/workflows/ 2>/dev/null || true

          # List remaining files for verification
          echo "Remaining files after cleanup:"
          git ls-files

      - name: Configure SSH for deploy key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PUBLIC_MIRROR_DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Configure SSH to use deploy key for github.com
          cat >> ~/.ssh/config <<EOF
          Host github.com
            HostName github.com
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF

          chmod 600 ~/.ssh/config

      - name: Configure Git
        run: |
          git config --global user.name "Stax Release Bot"
          git config --global user.email "noreply@firecrownmedia.com"

      - name: Add public mirror remote
        run: |
          git remote add public git@github.com:Firecrown-Media/stax-public.git
          git remote -v

      - name: Copy public README
        run: |
          if [ -f docs/PUBLIC_MIRROR_README.md ]; then
            echo "Copying public mirror README..."
            cp docs/PUBLIC_MIRROR_README.md README.md
            git add README.md
            git commit -m "docs: update README for public mirror" || echo "No changes to README"
          else
            echo "Warning: docs/PUBLIC_MIRROR_README.md not found, keeping existing README"
          fi

      - name: Push to public mirror
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"

          echo "Pushing tag ${TAG} to public mirror..."

          # Force push the current state to main
          git push public HEAD:main --force

          # Delete old tag locally and create new one pointing to cleaned HEAD
          # This is necessary because the original tag points to a commit with workflows
          git tag -d "${TAG}" 2>/dev/null || true
          git tag "${TAG}"

          # Push the tag
          git push public "${TAG}" --force

          echo "Successfully synced ${TAG} to public mirror"

      - name: Verify sync
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"

          echo "Verifying sync to public mirror..."

          # Fetch from public mirror
          git fetch public

          # Check if tag exists on remote
          if git ls-remote --tags public | grep -q "refs/tags/${TAG}"; then
            echo "✓ Tag ${TAG} successfully pushed to public mirror"
          else
            echo "✗ Tag ${TAG} not found on public mirror"
            exit 1
          fi

          # Check if main branch was updated
          if git ls-remote public | grep -q "refs/heads/main"; then
            echo "✓ Main branch successfully updated on public mirror"
          else
            echo "✗ Main branch not found on public mirror"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f ~/.ssh/config

      - name: Summary
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"
          echo "## Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully synced **${TAG}** to public mirror repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: [stax-public](https://github.com/Firecrown-Media/stax-public)" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: main" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Cleaned" >> $GITHUB_STEP_SUMMARY
          echo "- .claude/ directory" >> $GITHUB_STEP_SUMMARY
          echo "- *.claude.md files" >> $GITHUB_STEP_SUMMARY
          echo "- dist/ directory" >> $GITHUB_STEP_SUMMARY
          echo "- .DS_Store files" >> $GITHUB_STEP_SUMMARY
